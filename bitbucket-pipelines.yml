# This is a sample build configuration for Java ï¿½ Maven.
# Check our guides at https://confluence.atlassian.com/x/zd-5Mw for more examples.
# Only use spaces to indent your .yml configuration.
# -----
# You can specify a custom docker image from Docker Hub as your build environment.
image: maven:3.6.2-jdk-8

clone:
  depth: full # Required for sonarcloud
pipelines:
  default:
    - step:
        name: Verify
        caches:
          - maven
        script: # Modify the commands below to build your repository.
          - mvn --batch-mode verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
  branches:
    master:
      - step:
          name: Build and deploy
          caches:
            - maven
          script:
            - bash pipelines/configure-maven.sh
            - mvn --batch-mode source:jar javadoc:jar javadoc:javadoc deploy org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
          artifacts: # defining the artifacts to be passed to each future step.
            - target/**
      - step:
          name: Javadoc deploy
          image: cschlosser/alpine-lftps
          script:
            - sh pipelines/upload-javadoc.sh
      - step:
          name: Set jar available for download
          script:
            - curl -X POST "https://${BB_AUTH_STRING}@api.bitbucket.org/2.0/repositories/${BITBUCKET_REPO_OWNER}/${BITBUCKET_REPO_SLUG}/downloads" --form files=@"$(ls target/*.jar | grep -v ^target/original | grep -v javadoc.jar$ | grep -v sources.jar$)"
